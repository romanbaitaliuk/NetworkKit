/*
 Copyright (C) 2011-2021 Fiserv, Inc. or its affiliates. All rights reserved. This work,
 including its contents and programming, is confidential and its use is
 strictly limited. This work is furnished only for use by duly authorized
 licensees of Fiserv, Inc. or its affiliates, and their designated agents or
 employees responsible for installation or operation of the products. Any other
 use, duplication, or dissemination without the prior written consent of
 Fiserv, Inc. or its affiliates is strictly prohibited. Except as specified by
 the agreement under which the materials are furnished, Fiserv, Inc. and its
 affiliates do not accept any liabilities with respect to the information
 contained herein and are not responsible for any direct, indirect, special,
 consequential or exemplary damages resulting from the use of this information.
 No warranties, either express or implied, are granted or extended by this work
 or the delivery of this work.
 */

import XCTest
@testable import NetworkKit

final class SSLPinningTests: XCTestCase {
    private let localValidCertificate1 = "MIIDVDCCAjygAwIBAgIDAjRWMA0GCSqGSIb3DQEBBQUAMEIxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1HZW9UcnVzdCBJbmMuMRswGQYDVQQDExJHZW9UcnVzdCBHbG9iYWwgQ0EwHhcNMDIwNTIxMDQwMDAwWhcNMjIwNTIxMDQwMDAwWjBCMQswCQYDVQQGEwJVUzEWMBQGA1UEChMNR2VvVHJ1c3QgSW5jLjEbMBkGA1UEAxMSR2VvVHJ1c3QgR2xvYmFsIENBMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2swYYzD99BcjGlZ+W988bDjkcbd4kdS8odhM+KhDtgPpTSEHCIjaWC9mOSm9BXiLnTjoBbdqfnGk5sRgprDvgOSJKA+eJdbtg/OtppHHmMlCGDUUna2YRpIuT8rxh0PBFpVXLVDviS2Aelet8u5fa9IAjbkU+BQVNdnARqN7csiRv8lVK83Qlz6cJmTM386DGXHKTubU1XupGc1V3sjs0l44U+VcT4wt/lAjNvxm5suOpDkZALeVAjmRCw7+OC7RHQWa9k0+bw8HHa8sHo9gOeL6NlMTOdReJivbPagUvTLrGAMoUgRx5aszPeE4uwc2hGKceeoWMPRfwCvocWvk+QIDAQABo1MwUTAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBTAephojYn7qwVkDBF9qn1luMrMTjAfBgNVHSMEGDAWgBTAephojYn7qwVkDBF9qn1luMrMTjANBgkqhkiG9w0BAQUFAAOCAQEANeMpauUvXVSOKVCUn5kaFOSPeCpilKInZ57QzxpeR+nBsqTP3UEaBU6bS+5Kb1VSsyShNwrrZHYqLizz/Tt1kL/6cdjHPTfStQWVYrmm3ok9Nns4d0iXrKYgjy6myQzCsplFAMfOEVEiIuCl6rYVSAlk6l5PdPcFPseKUgzbFbS9bZvlxrFUaKnjaZC2mqUPuLk/IH2uSrW4nOQdtqvmlKXBx4Ot2/Unhw4EbNX/3aBd7YdStysVAq45pmp06drE57xNNB6pXE0zX5IJL4hmXXeXxx12E6nV5fEWCRE11azbJHFwLJhWC9kXtNHjUStedejV0NxPNO3CBWaAocvmMw=="
    private let localValidCertificate2 = "MIIDVDCCAjygAwIBAgIDAjRWMA0GCSqGSIb3DQEBBQUAMEIxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1HZW9UcnVzdCBJbmMuMRswGQYDVQQDExJHZW9UcnVzdCBHbG9iYWwgQ0EwHhcNMDIwNTIxMDQwMDAwWhcNMjIwNTIxMDQwMDAwWjBCMQswCQYDVQQGEwJVUzEWMBQGA1UEChMNR2VvVHJ1c3QgSW5jLjEbMBkGA1UEAxMSR2VvVHJ1c3QgR2xvYmFsIENBMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2swYYzD99BcjGlZ+W988bDjkcbd4kdS8odhM+KhDtgPpTSEHCIjaWC9mOSm9BXiLnTjoBbdqfnGk5sRgprDvgOSJKA+eJdbtg/OtppHHmMlCGDUUna2YRpIuT8rxh0PBFpVXLVDviS2Aelet8u5fa9IAjbkU+BQVNdnARqN7csiRv8lVK83Qlz6cJmTM386DGXHKTubU1XupGc1V3sjs0l44U+VcT4wt/lAjNvxm5suOpDkZALeVAjmRCw7+OC7RHQWa9k0+bw8HHa8sHo9gOeL6NlMTOdReJivbPagUvTLrGAMoUgRx5aszPeE4uwc2hGKceeoWMPRfwCvocWvk+QIDAQABo1MwUTAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBTAephojYn7qwVkDBF9qn1luMrMTjAfBgNVHSMEGDAWgBTAephojYn7qwVkDBF9qn1luMrMTjANBgkqhkiG9w0BAQUFAAOCAQEANeMpauUvXVSOKVCUn5kaFOSPeCpilKInZ57QzxpeR+nBsqTP3UEaBU6bS+5Kb1VSsyShNwrrZHYqLizz/Tt1kL/6cdjHPTfStQWVYrmm3ok9Nns4d0iXrKYgjy6myQzCsplFAMfOEVEiIuCl6rYVSAlk6l5PdPcFPseKUgzbFbS9bZvlxrFUaKnjaZC2mqUPuLk/IH2uSrW4nOQdtqvmlKXBx4Ot2/Unhw4EbNX/3aBd7YdStysVAq45pmp06drE57xNNB6pXE0zX5IJL4hmXXeXxx12E6nV5fEWCRE11azbJHFwLJhWC9kXtNHjUStedejV0NxPNO3CBWaAocvmMw=="
    private let localInvalidCertificate = "MIIE0zCCA7ugAwIBAgIQGNrRniZ96LtKIVjNzGs7SjANBgkqhkiG9w0BAQUFADCByjELMAkGA1UEBhMCVVMxFzAVBgNVBAoTDlZlcmlTaWduLCBJbmMuMR8wHQYDVQQLExZWZXJpU2lnbiBUcnVzdCBOZXR3b3JrMTowOAYDVQQLEzEoYykgMjAwNiBWZXJpU2lnbiwgSW5jLiAtIEZvciBhdXRob3JpemVkIHVzZSBvbmx5MUUwQwYDVQQDEzxWZXJpU2lnbiBDbGFzcyAzIFB1YmxpYyBQcmltYXJ5IENlcnRpZmljYXRpb24gQXV0aG9yaXR5IC0gRzUwHhcNMDYxMTA4MDAwMDAwWhcNMzYwNzE2MjM1OTU5WjCByjELMAkGA1UEBhMCVVMxFzAVBgNVBAoTDlZlcmlTaWduLCBJbmMuMR8wHQYDVQQLExZWZXJpU2lnbiBUcnVzdCBOZXR3b3JrMTowOAYDVQQLEzEoYykgMjAwNiBWZXJpU2lnbiwgSW5jLiAtIEZvciBhdXRob3JpemVkIHVzZSBvbmx5MUUwQwYDVQQDEzxWZXJpU2lnbiBDbGFzcyAzIFB1YmxpYyBQcmltYXJ5IENlcnRpZmljYXRpb24gQXV0aG9yaXR5IC0gRzUwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCvJAgIKXo1nmAMqudLO07cfLw8RRy7K+D+KQL5VwijZIUVJ/XxrcgxiV0i6CqqpkKzj/i5Vbext0uz/o9+B1fs70PbZmIVYc9gDaTY3vjgw2IIPVQT60nKWVSFJuUrjxuf6/WhkcIzSdhDY2pSS9KP6HBRTdGJaXvHcPaz3BJ023tdS1bTlr8Vd6Gw9KIl8q8ckmcY5fQGBO+QueQA5N06tRn/Arr0PO7gi+s3i+z016zy9vA9r911kTMZHRxAy3QkGSGT2RT+rCpSx4/VBEnkjWNHiDxpg8v+R70rfk/Fla4OndTRQ8Bnc+MUCH7lP59zuDMKz10/NIeWiu5T6CUVAgMBAAGjgbIwga8wDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAQYwbQYIKwYBBQUHAQwEYTBfoV2gWzBZMFcwVRYJaW1hZ2UvZ2lmMCEwHzAHBgUrDgMCGgQUj+XTGoasjY5rw8+AatRIGCx7GS4wJRYjaHR0cDovL2xvZ28udmVyaXNpZ24uY29tL3ZzbG9nby5naWYwHQYDVR0OBBYEFH/TZafC3ey78DAJ80M5+gKvMzEzMA0GCSqGSIb3DQEBBQUAA4IBAQCTJEowX2LP2BqYLz3q3JktvXf2pXkiOOzEp6B4Eq1iDkVwZMXnl2YtmAl+X6/WzChl8gGqCBpH3vn5fJJaCGkgDdk+bW48DW7Y5gaRQBi5+MHt39tBquCWIMnNZBU4gcmU7qKEKQsTb47bDN0lAtukixlE0kF6BWlKWE9gyn6CagsCqiUXObXbf+eEZSqVir2G3l6BFoMtEMze/aiCKm0oHw0LxOXnGiYZ4fQRbxC1lfznQgUy286dUV4otp6F01vvpX1FQHKOtw5rDgb7MzVIcbidJ4vEZV8NhnacRHr2lVz2XTIIM6RUthg/aFzyQkqFOFSDX9HoLPKsEdao7WNq"


    func testGetCredentialForServerTrustInProtectionSpaceWithValidCertificates() {
        let config = SSLPinningConfiguration(sslCertificates: [self.localValidCertificate1, self.localValidCertificate2], sslPinningCertificateType: .root)
        let sslPinning = SSLPining(sslPinningConfig: config)
        let mockedProtectionSpace = self.mockProtectionSpace()
        let credentials = sslPinning.getCredentialInProtectionSpace(protetionSpace: mockedProtectionSpace)
        XCTAssertNotNil(credentials, "Credentials should not be nil")
    }

    func testGetCredentialForServerTrustInProtectionSpaceWithOneInvalidCertificate() {
        let config = SSLPinningConfiguration(sslCertificates: [self.localInvalidCertificate, self.localValidCertificate2], sslPinningCertificateType: .root)
        let sslPinning = SSLPining(sslPinningConfig: config)
        let mockedProtectionSpace = self.mockProtectionSpace()
        let credentials = sslPinning.getCredentialInProtectionSpace(protetionSpace: mockedProtectionSpace)
        XCTAssertNotNil(credentials, "Credentials should not be nil")
    }

    func testGetCredentialForServerTrustInProtectionSpaceWithInvalidAlternativeCertificates() {
        let config = SSLPinningConfiguration(sslCertificates: [self.localValidCertificate1, self.localInvalidCertificate], sslPinningCertificateType: .root)
        let sslPinning = SSLPining(sslPinningConfig: config)
        let mockedProtectionSpace = self.mockProtectionSpace()
        let credentials = sslPinning.getCredentialInProtectionSpace(protetionSpace: mockedProtectionSpace)
        XCTAssertNotNil(credentials, "Credentials should not be nil")
    }

    func testGetCredentialsWhenNonRootCertificateSSLPinningIsPerformed() {
        let config = SSLPinningConfiguration(sslCertificates: [self.localValidCertificate1, self.localValidCertificate2], sslPinningCertificateType: .leaf)
        let sslPinning = SSLPining(sslPinningConfig: config)
        let mockedProtectionSpace = self.mockProtectionSpace()
        let credentials = sslPinning.getCredentialInProtectionSpace(protetionSpace: mockedProtectionSpace)
        XCTAssertNotNil(credentials, "Credentials should not be nil")
    }

    func testGetCredentialForServerTrustInProtectionSpaceWithInvalidCertificates() {
        let config = SSLPinningConfiguration(sslCertificates: [self.localInvalidCertificate, self.localInvalidCertificate], sslPinningCertificateType: .leaf)
        let sslPinning = SSLPining(sslPinningConfig: config)
        let mockedProtectionSpace = self.mockProtectionSpace()
        let credentials = sslPinning.getCredentialInProtectionSpace(protetionSpace: mockedProtectionSpace)
        XCTAssertNil(credentials, "Credentials should be nil")
    }

    func testGetCredentialForServerTrustInProtectionSpaceWithoutCertificates() {
        let config = SSLPinningConfiguration(sslCertificates: [], sslPinningCertificateType: .leaf)
        let sslPinning = SSLPining(sslPinningConfig: config)
        let mockedProtectionSpace = self.mockProtectionSpace()
        let credentials = sslPinning.getCredentialInProtectionSpace(protetionSpace: mockedProtectionSpace)
        XCTAssertNil(credentials, "Credentials should be nil")
    }

    func testGetCredentialForServerTrustInProtectionSpaceWithoutOneCertificate() {
        let config = SSLPinningConfiguration(sslCertificates: ["", self.localValidCertificate2], sslPinningCertificateType: .leaf)
        let sslPinning = SSLPining(sslPinningConfig: config)
        let mockedProtectionSpace = self.mockProtectionSpace()
        let credentials = sslPinning.getCredentialInProtectionSpace(protetionSpace: mockedProtectionSpace)
        XCTAssertNotNil(credentials, "Credentials should not be nil")
    }

    func testGetCredentialForServerTrustInProtectionSpaceWithoutAlternativeCertificate() {
        let config = SSLPinningConfiguration(sslCertificates: [self.localValidCertificate1, ""], sslPinningCertificateType: .leaf)
        let sslPinning = SSLPining(sslPinningConfig: config)
        let mockedProtectionSpace = self.mockProtectionSpace()
        let credentials = sslPinning.getCredentialInProtectionSpace(protetionSpace: mockedProtectionSpace)
        XCTAssertNotNil(credentials, "Credentials should not be nil")
    }

    private func mockProtectionSpace() -> URLProtectionSpace {
        let url = URL(string: "https://google.com")!
        let protectionSpace = MockedURLProtectionSpace(host: url.host!,
                                                       port: 80,
                                                       protocol: url.scheme,
                                                       realm: nil,
                                                       authenticationMethod: NSURLAuthenticationMethodServerTrust)
        return protectionSpace
    }
}

private class MockedURLProtectionSpace: URLProtectionSpace {
    private let serverCertificate = "MIIDVDCCAjygAwIBAgIDAjRWMA0GCSqGSIb3DQEBBQUAMEIxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1HZW9UcnVzdCBJbmMuMRswGQYDVQQDExJHZW9UcnVzdCBHbG9iYWwgQ0EwHhcNMDIwNTIxMDQwMDAwWhcNMjIwNTIxMDQwMDAwWjBCMQswCQYDVQQGEwJVUzEWMBQGA1UEChMNR2VvVHJ1c3QgSW5jLjEbMBkGA1UEAxMSR2VvVHJ1c3QgR2xvYmFsIENBMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2swYYzD99BcjGlZ+W988bDjkcbd4kdS8odhM+KhDtgPpTSEHCIjaWC9mOSm9BXiLnTjoBbdqfnGk5sRgprDvgOSJKA+eJdbtg/OtppHHmMlCGDUUna2YRpIuT8rxh0PBFpVXLVDviS2Aelet8u5fa9IAjbkU+BQVNdnARqN7csiRv8lVK83Qlz6cJmTM386DGXHKTubU1XupGc1V3sjs0l44U+VcT4wt/lAjNvxm5suOpDkZALeVAjmRCw7+OC7RHQWa9k0+bw8HHa8sHo9gOeL6NlMTOdReJivbPagUvTLrGAMoUgRx5aszPeE4uwc2hGKceeoWMPRfwCvocWvk+QIDAQABo1MwUTAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBTAephojYn7qwVkDBF9qn1luMrMTjAfBgNVHSMEGDAWgBTAephojYn7qwVkDBF9qn1luMrMTjANBgkqhkiG9w0BAQUFAAOCAQEANeMpauUvXVSOKVCUn5kaFOSPeCpilKInZ57QzxpeR+nBsqTP3UEaBU6bS+5Kb1VSsyShNwrrZHYqLizz/Tt1kL/6cdjHPTfStQWVYrmm3ok9Nns4d0iXrKYgjy6myQzCsplFAMfOEVEiIuCl6rYVSAlk6l5PdPcFPseKUgzbFbS9bZvlxrFUaKnjaZC2mqUPuLk/IH2uSrW4nOQdtqvmlKXBx4Ot2/Unhw4EbNX/3aBd7YdStysVAq45pmp06drE57xNNB6pXE0zX5IJL4hmXXeXxx12E6nV5fEWCRE11azbJHFwLJhWC9kXtNHjUStedejV0NxPNO3CBWaAocvmMw=="

    override var serverTrust: SecTrust? {
        get {
            do {
                let serverCertData = try XCTUnwrap(NSData(base64Encoded: self.serverCertificate))
                let serverCertificate = try XCTUnwrap(SecCertificateCreateWithData(kCFAllocatorDefault, serverCertData))
                let certArray = [serverCertificate]
                var optionalTrust: SecTrust?
                let policyInfo = SecPolicyCreateSSL(true, self.host as CFString)
                let status = SecTrustCreateWithCertificates(certArray as AnyObject,
                                                            policyInfo,
                                                            &optionalTrust)
                XCTAssertNotNil(optionalTrust)
                XCTAssertEqual(status, errSecSuccess)
                var trustResult = SecTrustResultType.invalid
                let evaStatus = SecTrustEvaluate(try XCTUnwrap(optionalTrust), &trustResult)
                XCTAssertEqual(evaStatus, errSecSuccess)
                return optionalTrust
            } catch {
                return nil
            }
        }
    }
}
